# 后端服务设计

## 1. 技术选型

*   **语言**: [待定，Go 优先考虑]
*   **Web 框架**: [待定，如 Gin 或 Echo]
*   **ORM**: [待定，如 GORM]
*   **依赖管理**: [如 Go Modules]

## 2. 内部架构/分层

推荐采用分层架构，如：

*   **Handler/Controller 层**: 接收 HTTP 请求，解析参数，调用 Service 层，组装响应。
*   **Service 层**: 实现核心业务逻辑，处理数据校验、事务管理、调用 Repository。
*   **Repository/DAL 层**: 负责与数据库交互，封装数据访问逻辑。
*   **Model 层**: 定义数据结构 (对应数据库表)。

## 3. 核心模块设计 (V1.0)

*   **用户认证与授权 (AuthN & AuthZ)**:
    *   实现登录接口，校验用户名密码，生成 JWT。
    *   设计中间件，拦截请求，校验 JWT，并将用户信息注入上下文。
    *   实现 RBAC 检查逻辑，根据用户角色和请求资源/操作进行权限判断。
*   **环境管理 (Environment)**:
    *   实现 CRUD 操作对应的 Service 和 Repository 逻辑。
    *   处理环境与服务实例、资产、职责组的关联关系。
*   **Bug 管理 (Bug)**:
    *   实现 Bug 提交逻辑，注意关联环境、服务、业务等信息。
    *   实现 Bug 状态流转逻辑。
    *   实现 Bug 分配逻辑 (V1.0 可能先手动分配，V1.1 考虑基于规则自动分配)。
*   **审计日志 (AuditLog)**:
    *   设计 AOP (面向切面编程) 方式或在 Service 层关键操作后显式记录审计日志。
    *   异步写入日志以减少对主流程性能影响。

## 4. 配置管理

*   使用配置文件 (如 YAML, TOML) 或环境变量管理服务配置（数据库连接、端口、日志级别等）。
*   考虑使用配置中心（如 Nacos, Consul）进行动态配置管理（未来）。

## 5. 日志记录

*   使用结构化日志库 (如 Zap, Logrus for Go)。
*   日志应包含时间戳、级别、请求 ID (用于追踪)、代码位置、消息内容。
*   日志输出到文件，并考虑日志轮转 (Rotation)。
*   (未来)考虑将日志集中推送到日志平台 (如 ELK, Loki)。

## 6. 错误处理

*   定义统一的错误码和错误结构。
*   在 Service 层捕获并处理业务异常，转换为统一错误码。
*   在 Handler 层将错误转换为统一的 API 响应格式。

## 7. 与数据采集器通信 (V1.1+)

*   设计与采集器的通信协议（如 HTTP REST 或 gRPC）。
*   考虑安全性（如 mTLS 双向认证）。
*   处理异步任务（如下发日志获取指令并等待结果）。

</rewritten_file> 